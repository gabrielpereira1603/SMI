
<div class="text">
    <h1>Manutenção Laboratório </h1>
</div>

<div class="manutencao-labs">
    <form action="" method="POST" class="form-manutencao mt-2" id="form-manutencao">
        <div class="inputs">
            <legend>Inserir ou Editar Laboratórios</legend>

            <select class="form-select" aria-label="Default select example" id="nomelaboratorio" name="laboratorio">
                <option value="">Selecione um Laboratório</option>
                {{selectLabs}}
            </select>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-secondary">Editar Laboratório</button>
            <button class="btn btn-success" type="submit">Criar Laboratório</button>
        </div>
    </form>
    <script>
        document.querySelector('.btn-secondary').addEventListener('click', function(event) {
            event.preventDefault(); // Prevenir o envio do formulário

            // Seleciona o option atualmente selecionado no select
            const select = document.getElementById('nomelaboratorio');
            const selectedOption = select.options[select.selectedIndex];

            // Acessa o atributo data-service-numerolaboratorio
            const numeroLaboratorio = selectedOption.getAttribute('data-service-numerolaboratorio');
            const idLaboratorio = document.getElementById('nomelaboratorio').value

            if (!numeroLaboratorio) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atenção!',
                    text: 'Por favor, selecione um laboratório para editar.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Mude o título e o botão do modal
            document.getElementById('createLabModalLabel').textContent = 'Editar Laboratório';
            document.getElementById('salvarLabBtn').textContent = 'Salvar Alterações';

            // Preencha o campo do modal com o nome do laboratório selecionado
            document.getElementById('novoNomeLaboratorio').value = numeroLaboratorio;

            // Mudar a ação do formulário para o endpoint de edição
            document.getElementById('form-criar-lab').action = '{{URL}}/admin/gerenciar/editLabs/' + idLaboratorio;

            // Exibir o modal
            const createLabModal = new bootstrap.Modal(document.getElementById('createLabModal'));
            createLabModal.show();
        });

        document.querySelector('.btn-success').addEventListener('click', function(event) {
            event.preventDefault(); // Prevenir o envio do formulário

            // Mude o título e o botão do modal para o modo de criação
            document.getElementById('createLabModalLabel').textContent = 'Criar Novo Laboratório';
            document.getElementById('salvarLabBtn').textContent = 'Salvar';

            // Limpe o campo do nome do laboratório
            document.getElementById('novoNomeLaboratorio').value = '';

            // Mudar a ação do formulário para o endpoint de criação
            document.getElementById('form-criar-lab').action = '{{URL}}/admin/gerenciar/addLabs';

            // Exibir o modal
            const createLabModal = new bootstrap.Modal(document.getElementById('createLabModal'));
            createLabModal.show();
        });
    </script>
    <div class="modal fade" id="createLabModal" tabindex="-1" aria-labelledby="createLabModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createLabModalLabel">Criar Novo Laboratório</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-criar-lab" action="{{URL}}/admin/gerenciar/addLabs" method="post">
                    <div class="modal-body">
                        <p style="text-align: center; margin: 0px; font-size: 12px; color: gray;">
                            OBS: <strong>BASTA COLOCAR O NÚMERO DO LABORATÓRIO QUE DESEJA CRIAR. EX: 10, 09, 03...</strong>
                        </p>
                        <div class="mb-3">
                            <label for="novoNomeLaboratorio" class="form-label">Nome do Laboratório</label>
                            <input type="text" class="form-control" id="novoNomeLaboratorio" name="numerolaboratorio" placeholder="Digite o nome do laboratório">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="salvarLabBtn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <form action="" method="POST" class="form-manutencao">
        <div class="inputs">
            <legend>Inserir ou Excluir Computador</legend>

            <!-- Select para escolher o laboratório -->
            <select class="form-select" id="min-laboratorio" aria-label="Default select example" name="laboratorio">
                <option value="">Selecione um laboratório</option>
                {{selectLabs}}
            </select>

            <!-- Select para escolher o computador -->
            <select class="form-select" id="min-computador" aria-label="Default select example" name="computador">
                <option value="">Selecione um laboratório primeiro</option>
            </select>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-secondary" type="button" id="editComputadorBtn">Editar Computador</button>
            <button class="btn btn-success" type="submit">Criar Computador</button>
        </div>
    </form>

    <!-- Modal -->
    <div class="modal fade" id="computadorModal" tabindex="-1" aria-labelledby="computadorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="computadorModalLabel">Editar Computador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="computadorForm" action="{{URL}}/admin/gerenciar/editPc" method="post">
                        <div class="mb-3">
                            <label for="patrimonio" class="form-label">Patrimônio</label>
                            <input type="text" class="form-control" id="patrimonio" name="patrimonio" required>
                        </div>
                        <div class="mb-3">
                            <label for="situacao" class="form-label">Situação</label>
                            <select class="form-select" id="situacao" name="situacao" required>
                                <!-- Options will be added dynamically -->
                            </select>
                        </div>
                        <input type="hidden" id="computadorId" name="computadorId">
                        <input type="hidden" id="tipoSituacao" name="tiposituacao"> <!-- Campo oculto para o tipo de situação -->
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.getElementById('min-laboratorio').addEventListener('change', function() {
            const codLaboratorio = this.value;

            if (codLaboratorio) {
                fetch(`{{URL}}/api/v1/computador/${codLaboratorio}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (Array.isArray(data)) {
                            const computadorSelect = document.getElementById('min-computador');
                            computadorSelect.innerHTML = '<option value="">Selecione um computador</option>';

                            data.forEach(computador => {
                                const option = document.createElement('option');
                                option.value = computador.codcomputador;
                                option.textContent = computador.patrimonio;
                                computadorSelect.appendChild(option);
                            });
                        } else {
                            console.error('Resposta da API não é um array:', data);
                            document.getElementById('min-computador').innerHTML = '<option value="">Erro ao carregar computadores</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar computadores:', error);
                        document.getElementById('min-computador').innerHTML = '<option value="">Erro ao carregar computadores</option>';
                    });
            } else {
                document.getElementById('min-computador').innerHTML = '<option value="">Selecione um laboratório primeiro</option>';
            }
        });

        // Atualizar o valor do campo oculto 'tiposituacao' quando o usuário selecionar uma nova situação
        document.getElementById('situacao').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById('tipoSituacao').value = selectedOption.textContent; // Armazena o texto (tiposituacao)
        });


        document.getElementById('editComputadorBtn').addEventListener('click', function() {
            const computadorSelect = document.getElementById('min-computador');
            const selectedOption = computadorSelect.options[computadorSelect.selectedIndex];

            if (selectedOption.value) {
                const computadorId = selectedOption.value;

                // Buscar todas as situações
                fetch(`{{URL}}/api/v1/situacao/all`)
                    .then(response => response.json())
                    .then(situacoes => {
                        fetch(`{{URL}}/api/v1/computador/${document.getElementById('min-laboratorio').value}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                const computador = data.find(comp => comp.codcomputador == computadorId);
                                if (computador) {
                                    // Preenche os campos do modal
                                    document.getElementById('computadorId').value = computador.codcomputador;
                                    document.getElementById('patrimonio').value = computador.patrimonio;

                                    // Preenche o select de situação
                                    const situacaoSelect = document.getElementById('situacao');
                                    situacaoSelect.innerHTML = ''; // Limpa as opções

                                    situacoes.forEach(situacao => {
                                        const option = document.createElement('option');
                                        option.value = situacao.codsituacao;
                                        option.textContent = situacao.tiposituacao;
                                        if (situacao.tiposituacao === computador.tiposituacao) {
                                            option.selected = true; // Marca a situação atual
                                        }
                                        situacaoSelect.appendChild(option);
                                    });

                                    // Atualizar o campo oculto 'tiposituacao' com a situação atual
                                    document.getElementById('tipoSituacao').value = computador.tiposituacao;

                                    // Abre o modal
                                    var myModal = new bootstrap.Modal(document.getElementById('computadorModal'));
                                    myModal.show();
                                }
                            })
                            .catch(error => console.error('Erro ao buscar dados do computador:', error));
                    })
                    .catch(error => console.error('Erro ao buscar todas as situações:', error));
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atenção!',
                    text: 'Por favor, selecione um computador para editar.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
            }
        });

    </script>



    <form action="?router=ManutencaoLabsController/alterComp" method="POST" class="form-manutencao">
        <fieldset>
            <legend>Inserir Novos Componentes</legend>
            <select class="form-select" aria-label="Default select example" name="componente-existente" id="select-componente">
                <option value="">Selecione um componente</option>
                <?php foreach ($buscarComponentes as $componentes): ?>
                <?php endforeach; ?>
            </select>

            <div class="form-floating mb-3" id="inputs-componentes">
                <input type="text" class="form-control" id="nome-componente" name="nome-componente" placeholder="Nome Componente" required>
                <label for="floatingInput">Nome Componente</label>
            </div>
            <input type="hidden" name="acao" id="acao-comp" value="">
        </fieldset>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-danger" type="submit" onclick="setAcao('excluir')">Excluir Componente</button>
            <button class="btn btn-primary" type="submit" onclick="setAcao('criar')">Criar Componente</button>
        </div>
    </form>

</div>

